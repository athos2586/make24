<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>10â€‘Year Investment Game</title>
<style>
  :root {
    --bg: #0f1221;
    --panel: #171a2b;
    --panel-2: #1f2340;
    --text: #e7e9ee;
    --muted: #b9bed1;
    --accent: #7c9cff;
    --accent-2: #6ce0c3;
    --danger: #ff7685;
    --warning: #ffd36c;
    --good: #88f087;
    --line: #2d3155;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 800px at 80% -20%, #2a2f57 0%, var(--bg) 40%) fixed;
    color: var(--text);
    font-size: 12px;
    line-height: 1.35;
  }
  header { padding: 16px; text-align: center; }
  header h1 { margin: 0 0 4px; font-size: 18px; }
  header p { margin: 0; color: var(--muted); font-size: 11px; }
  .container {
    max-width: 1100px;
    margin: 10px auto 40px;
    padding: 0 10px;
    display: grid;
    grid-template-columns: 1fr 2fr; /* left inputs, right chart+table */
    gap: 10px;
    align-items: start;
  }
  @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
  .card {
    background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .card h2 { margin: 4px 4px 8px; font-size: 13px; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
  .field { margin: 4px; }
  label { display:block; font-size:10px; color:var(--muted); margin-bottom:4px; }
  input[type="number"], input[type="text"] {
    width: 100%; background:#0f1221; color:var(--text);
    border: 1px solid #343a66; border-radius: 6px; padding: 6px; outline: none; font-size: 11px;
  }
  input[type="range"] { width: 100%; accent-color: var(--accent); }
  .pill {
    display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:999px;
    background:#121631; color:var(--text); border:1px solid #2b2f57; cursor:pointer; user-select:none;
    font-size: 10px;
  }
  .pill:hover { border-color:#3b4070; }
  .btn {
    background: linear-gradient(180deg, #4a66ff, #2f48d9);
    border: none; color: white; padding: 6px 8px; border-radius: 6px;
    font-weight: 600; cursor: pointer; box-shadow: 0 3px 6px rgba(76,99,255,.3);
    font-size: 11px;
  }
  .btn:disabled { opacity:.55; cursor:not-allowed; }
  .btn.secondary { background:#192044; border:1px solid #3a4080; box-shadow:none; }
  .btn.danger {
    background: linear-gradient(180deg, #ff6b7a, #da3f51);
    box-shadow: 0 3px 6px rgba(255,107,122,.3);
  }
  .hint { color: var(--muted); font-size: 10px; }
  .kpi { display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin:4px; }
  .kpi .box { background:#111633; border:1px solid #2c325f; border-radius:6px; padding:6px; }
  .kpi .big { font-size: 12px; font-weight: 700; }
  .good { color: var(--good); } .bad { color: var(--danger); } .warn { color: var(--warning); }
  table { width:100%; border-collapse: collapse; margin-top: 6px; font-size:11px; }
  th, td { border-bottom: 1px solid #2c315c; padding: 4px; text-align: right; }
  th { color: var(--muted); font-weight: 600; }
  td.label, th.label { text-align: left; }
  canvas { width:100%; height:210px; border-radius:6px; background:#0e1330; border:1px solid #2b2f57; }
  .alloc-row { display:grid; grid-template-columns: 70px 1fr 40px; align-items:center; gap:6px; margin:4px; font-size:11px; }
  .preset-wrap { display:flex; gap:4px; flex-wrap:wrap; margin:4px; }
  .footer-note { margin: 4px; font-size: 10px; color: var(--muted); }
  .sep { height:1px; background:#2b2f57; margin: 6px; opacity:.7; }
</style>
</head>
<body>
<header>
  <h1>10â€‘Year Investment Game</h1>
  <p>Set allocation & assumptions, then lock each year. No extra contributions.</p>
</header>

<div class="container">
  <!-- LEFT: Inputs -->
  <section class="card">
    <h2>Inputs</h2>
    <div class="field">
      <label>Starting Balance</label>
      <input id="startBalance" type="number" value="10000" min="0" step="100" />
    </div>
    <div class="field">
      <label>Random Seed (optional)</label>
      <input id="seed" type="text" placeholder="e.g., my-seed" />
    </div>
    <div class="field" style="display:flex; gap:4px; justify-content:flex-end">
      <button id="resetBtn" class="btn danger">New Game</button>
    </div>

    <div class="sep"></div>
    <h2>Allocation</h2>
    <div class="preset-wrap">
      <button class="pill" data-preset="cautious">Cautious</button>
      <button class="pill" data-preset="balanced">Balanced</button>
      <button class="pill" data-preset="growth">Growth</button>
      <button class="pill" data-preset="allEquity">All Equity</button>
      <button class="pill" data-preset="allFixed">All Fixed</button>
      <button class="pill" data-preset="allCash">All Cash</button>
    </div>
    <div class="alloc-row">
      <div>Cash</div><input id="allocCash" type="range" min="0" max="100" value="20" /><div id="pctCash">20</div>
    </div>
    <div class="alloc-row">
      <div>Fixed</div><input id="allocFixed" type="range" min="0" max="100" value="50" /><div id="pctFixed">50</div>
    </div>
    <div class="alloc-row">
      <div>Equity</div><input id="allocEquity" type="range" min="0" max="100" value="30" /><div id="pctEquity">30</div>
    </div>
    <div class="preset-wrap">
      <button class="pill" id="normalizeBtn">Normalize</button>
      <button class="pill" id="rebalanceBtn">Rebalance</button>
    </div>

    <div class="sep"></div>
    <h2>Market Assumptions</h2>
    <div class="row3">
      <div class="field"><label>Cash %</label><input id="muCash" type="number" value="2" step="0.1" /></div>
      <div class="field"><label>Fixed %</label><input id="muFixed" type="number" value="4" step="0.1" /></div>
      <div class="field"><label>Equity %</label><input id="muEquity" type="number" value="8" step="0.1" /></div>
    </div>
    <div class="row3">
      <div class="field"><label>Cash Vol %</label><input id="sdCash" type="number" value="1" step="0.1" /></div>
      <div class="field"><label>Fixed Vol %</label><input id="sdFixed" type="number" value="5" step="0.1" /></div>
      <div class="field"><label>Equity Vol %</label><input id="sdEquity" type="number" value="15" step="0.1" /></div>
    </div>
    <div class="field" style="display:flex; justify-content:flex-end">
      <button id="applyAssumpBtn" class="btn secondary">Apply</button>
    </div>

    <div class="sep"></div>
    <h2>Progress</h2>
    <div class="kpi">
      <div class="box"><div class="hint">Year</div><div class="big" id="yearDisplay">1/10</div></div>
      <div class="box"><div class="hint">Value</div><div class="big" id="kpiValue">$10,000</div></div>
      <div class="box"><div class="hint">Return</div><div class="big" id="kpiYearRet">â€”</div></div>
      <div class="box"><div class="hint">CAGR</div><div class="big" id="kpiCAGR">â€”</div></div>
    </div>
    <div class="row">
      <button id="commitBtn" class="btn">Lock In âžœ</button>
      <button id="undoBtn" class="btn secondary">Undo</button>
    </div>
    <div class="footer-note">
      Returns are normally distributed per your assumptions. No annual contributions; compounding only.
    </div>
  </section>

  <!-- RIGHT: Chart + Table + Final -->
  <section class="card">
    <h2>Portfolio Over Time</h2>
    <canvas id="chart" width="900" height="210" aria-label="Portfolio value chart"></canvas>

    <h2>Yearly Log</h2>
    <table id="logTable">
      <thead>
        <tr>
          <th class="label">Year</th>
          <th>Cash/Fixed/Eq%</th>
          <th>Market C/F/E</th>
          <th>Weighted</th>
          <th>End Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Final Summary</h2>
    <div class="kpi">
      <div class="box"><div class="hint">Final</div><div class="big" id="finalValue">â€”</div></div>
      <div class="box"><div class="hint">Gain</div><div class="big" id="finalGain">â€”</div></div>
      <div class="box"><div class="hint">Total Ret</div><div class="big" id="finalTR">â€”</div></div>
      <div class="box"><div class="hint">10â€‘yr CAGR</div><div class="big" id="finalCAGR">â€”</div></div>
    </div>
    <div class="footer-note" id="finalNotes"></div>
  </section>
</div>

<script>
/* ---------- Utilities ---------- */
function mulberry32(a) {
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    var t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function hashStringToInt(str) {
  let h = 2166136261 >>> 0;
  for (let i=0; i<str.length; i++) { h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h >>> 0;
}
function makeNormal(rng) {
  let spare = null;
  return function(mean=0, sd=1) {
    if (spare !== null) { const z = spare; spare = null; return mean + sd * z; }
    let u=0, v=0, s=0;
    do { u = rng()*2-1; v = rng()*2-1; s = u*u + v*v; } while (s===0 || s>=1);
    const mul = Math.sqrt(-2 * Math.log(s) / s);
    spare = v * mul;
    return mean + sd * (u * mul);
  }
}
const fmt = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
const pct = (x) => (x>=0?'+':'') + (x*100).toFixed(2) + '%';
function computeCAGR(start, end, years){
  if (years <= 0 || start <= 0) return null;
  return Math.pow(end / start, 1/years) - 1;
}

/* ---------- State ---------- */
let state = {
  year: 1,
  startBalance: 10000,
  value: 10000,
  history: [],
  seedStr: '',
  rng: Math.random,
  normal: null,
  lastAlloc: { cash:20, fixed:50, equity:30 },
  params: {
    cash:   { mean: 0.02, sd: 0.01 },
    fixed:  { mean: 0.04, sd: 0.05 },
    equity: { mean: 0.08, sd: 0.15 },
  }
};

/* ---------- DOM ---------- */
const dom = {
  startBalance: document.getElementById('startBalance'),
  seed: document.getElementById('seed'),

  allocCash: document.getElementById('allocCash'),
  allocFixed: document.getElementById('allocFixed'),
  allocEquity: document.getElementById('allocEquity'),
  pctCash: document.getElementById('pctCash'),
  pctFixed: document.getElementById('pctFixed'),
  pctEquity: document.getElementById('pctEquity'),
  normalizeBtn: document.getElementById('normalizeBtn'),
  rebalanceBtn: document.getElementById('rebalanceBtn'),

  muCash: document.getElementById('muCash'),
  muFixed: document.getElementById('muFixed'),
  muEquity: document.getElementById('muEquity'),
  sdCash: document.getElementById('sdCash'),
  sdFixed: document.getElementById('sdFixed'),
  sdEquity: document.getElementById('sdEquity'),
  applyAssumpBtn: document.getElementById('applyAssumpBtn'),

  commitBtn: document.getElementById('commitBtn'),
  undoBtn: document.getElementById('undoBtn'),
  resetBtn: document.getElementById('resetBtn'),

  yearDisplay: document.getElementById('yearDisplay'),
  kpiValue: document.getElementById('kpiValue'),
  kpiYearRet: document.getElementById('kpiYearRet'),
  kpiCAGR: document.getElementById('kpiCAGR'),

  logTable: document.getElementById('logTable').querySelector('tbody'),
  chart: document.getElementById('chart'),

  finalValue: document.getElementById('finalValue'),
  finalGain: document.getElementById('finalGain'),
  finalTR: document.getElementById('finalTR'),
  finalCAGR: document.getElementById('finalCAGR'),
  finalNotes: document.getElementById('finalNotes'),
};

/* ---------- Helpers ---------- */
function readAssumptions() {
  const toDec = (x) => (Number(x)||0)/100;
  state.params.cash.mean   = toDec(dom.muCash.value);
  state.params.fixed.mean  = toDec(dom.muFixed.value);
  state.params.equity.mean = toDec(dom.muEquity.value);
  state.params.cash.sd     = toDec(dom.sdCash.value);
  state.params.fixed.sd    = toDec(dom.sdFixed.value);
  state.params.equity.sd   = toDec(dom.sdEquity.value);
}
function currentAlloc() {
  return {
    cash: Number(dom.allocCash.value),
    fixed: Number(dom.allocFixed.value),
    equity: Number(dom.allocEquity.value),
  };
}
function setAlloc(a) {
  dom.allocCash.value = a.cash;
  dom.allocFixed.value = a.fixed;
  dom.allocEquity.value = a.equity;
  updateAllocLabels();
}
function updateAllocLabels() {
  dom.pctCash.textContent = Number(dom.allocCash.value);
  dom.pctFixed.textContent = Number(dom.allocFixed.value);
  dom.pctEquity.textContent = Number(dom.allocEquity.value);
}
function normalizeAlloc() {
  let a = currentAlloc();
  let sum = a.cash + a.fixed + a.equity;
  if (sum === 0) { a = { cash: 100, fixed: 0, equity: 0 }; }
  else {
    a.cash   = Math.round(100 * a.cash / sum);
    a.fixed  = Math.round(100 * a.fixed / sum);
    a.equity = 100 - a.cash - a.fixed;
  }
  setAlloc(a);
}
function fmtAlloc(a){ return `${a.cash}/${a.fixed}/${a.equity}`; }
function enableControls() {
  dom.commitBtn.disabled = false;
  dom.rebalanceBtn.disabled = false;
  dom.normalizeBtn.disabled = false;
}
function setEditLocks(lock) {
  dom.startBalance.disabled = lock;
  dom.seed.disabled = lock;
  dom.muCash.disabled = lock; dom.muFixed.disabled = lock; dom.muEquity.disabled = lock;
  dom.sdCash.disabled = lock; dom.sdFixed.disabled = lock; dom.sdEquity.disabled = lock;
  dom.applyAssumpBtn.disabled = lock;
}

/* ---------- Core ---------- */
function init() {
  state.seedStr = (dom.seed.value.trim() ? dom.seed.value.trim() : 'seed-' + Date.now());
  state.rng = mulberry32(hashStringToInt(state.seedStr));
  state.normal = makeNormal(state.rng);

  state.startBalance = state.value = Math.max(0, Math.round(Number(dom.startBalance.value)||0));
  readAssumptions();

  state.year = 1;
  state.history = [];
  state.lastAlloc = currentAlloc();

  dom.yearDisplay.textContent = '1/10';
  dom.kpiValue.textContent = fmt.format(state.value);
  dom.kpiYearRet.textContent = 'â€”';
  dom.kpiCAGR.textContent = 'â€”';
  dom.logTable.innerHTML = '';
  clearFinal();
  drawChart();
  enableControls();
  setEditLocks(false);
}
function clearFinal() {
  dom.finalValue.textContent = 'â€”';
  dom.finalGain.textContent = 'â€”';
  dom.finalTR.textContent = 'â€”';
  dom.finalCAGR.textContent = 'â€”';
  dom.finalNotes.textContent = '';
}

function drawYear() {
  // Validate allocation
  let alloc = currentAlloc();
  const sum = alloc.cash + alloc.fixed + alloc.equity;
  if (sum !== 100) {
    alert('Allocations must sum to 100%. Click â€œNormalizeâ€ or adjust sliders.');
    return;
  }
  // Lock inputs after first commit
  if (state.history.length === 0) setEditLocks(true);

  // Market returns (normal dist) per assumptions
  const rCash   = state.normal(state.params.cash.mean, state.params.cash.sd);
  const rFixed  = state.normal(state.params.fixed.mean, state.params.fixed.sd);
  const rEquity = state.normal(state.params.equity.mean, state.params.equity.sd);

  // Weighted return (rebalance)
  const w = { cash: alloc.cash/100, fixed: alloc.fixed/100, equity: alloc.equity/100 };
  const weighted = rCash*w.cash + rFixed*w.fixed + rEquity*w.equity;

  // Apply return (no contributions)
  const before = state.value;
  const after = Math.max(0, before * (1 + weighted));

  // Update state
  state.value = Math.round(after);
  state.history.push({
    year: state.year,
    alloc: { ...alloc },
    market: { cash: rCash, fixed: rFixed, equity: rEquity },
    weightedRet: weighted,
    endBalance: state.value
  });
  state.lastAlloc = { ...alloc };

  // Update UI
  addRow(state.history[state.history.length-1]);
  dom.kpiValue.textContent = fmt.format(state.value);
  dom.kpiYearRet.textContent = (weighted >= 0 ? 'ðŸ“ˆ ' : 'ðŸ“‰ ') + pct(weighted);

  const cagrSoFar = computeCAGR(state.startBalance, state.value, state.year);
  dom.kpiCAGR.textContent = cagrSoFar === null ? 'â€”' : pct(cagrSoFar);

  drawChart();

  // Next year
  state.year++;
  dom.yearDisplay.textContent = `${Math.min(10, state.year)}/10`;

  if (state.history.length >= 10) finalize();
}
function addRow(entry) {
  const tr = document.createElement('tr');
  const mkt = `${pct(entry.market.cash)} / ${pct(entry.market.fixed)} / ${pct(entry.market.equity)}`;
  tr.innerHTML = `
    <td class="label">${entry.year}</td>
    <td>${fmtAlloc(entry.alloc)}</td>
    <td>${mkt}</td>
    <td class="${entry.weightedRet>=0?'good':'bad'}">${pct(entry.weightedRet)}</td>
    <td>${fmt.format(entry.endBalance)}</td>
  `;
  dom.logTable.appendChild(tr);
}
function finalize() {
  dom.commitBtn.disabled = true;
  dom.rebalanceBtn.disabled = true;
  dom.normalizeBtn.disabled = true;

  const finalValue = state.value;
  const invested = state.startBalance;
  const gain = finalValue - invested;
  const totalReturn = invested > 0 ? (finalValue / invested - 1) : null;
  const cagr = computeCAGR(invested, finalValue, 10);

  dom.finalValue.textContent = fmt.format(finalValue);
  dom.finalGain.textContent = (gain>=0? 'ðŸ“ˆ ' : 'ðŸ“‰ ') + fmt.format(gain);
  dom.finalTR.textContent = totalReturn===null? 'â€”' : pct(totalReturn);
  dom.finalCAGR.textContent = cagr===null? 'â€”' : pct(cagr);

  let best=null, worst=null;
  state.history.forEach(h => { if(!best||h.weightedRet>best.weightedRet) best=h; if(!worst||h.weightedRet<worst.weightedRet) worst=h; });
  dom.finalNotes.textContent =
    `Best year: Y${best.year} (${(best.weightedRet*100).toFixed(2)}%). ` +
    `Worst year: Y${worst.year} (${(worst.weightedRet*100).toFixed(2)}%). Seed: â€œ${state.seedStr}â€.`;

  dom.yearDisplay.textContent = '10/10';
}
function undoYear() {
  if (state.history.length === 0) return;
  const last = state.history.pop();
  state.year = last.year;
  state.value = (state.history.length ? state.history[state.history.length-1].endBalance : state.startBalance);

  // Remove last row
  dom.logTable.removeChild(dom.logTable.lastElementChild);

  // Update KPIs
  dom.kpiValue.textContent = fmt.format(state.value);
  dom.kpiYearRet.textContent = 'â€”';
  const cagrSoFar = computeCAGR(state.startBalance, state.value, state.year-1);
  dom.kpiCAGR.textContent = cagrSoFar===null ? 'â€”' : pct(cagrSoFar);
  dom.yearDisplay.textContent = `${state.year}/10`;

  // Re-enable controls if we backed out of year 10
  enableControls();
  drawChart();
  clearFinal();

  // If fully undone to start, unlock editables
  if (state.history.length === 0) {
    setEditLocks(false);
  }
}

/* ---------- Chart ---------- */
function drawChart() {
  const ctx = dom.chart.getContext('2d');
  const w = dom.chart.width, h = dom.chart.height;
  ctx.clearRect(0,0,w,h);

  const values = [state.startBalance, ...state.history.map(h=>h.endBalance)];
  const years = values.length - 1;
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const padL = 60, padR = 10, padT = 10, padB = 26;

  // Background
  ctx.fillStyle = '#0b1030'; ctx.fillRect(0,0,w,h);
  // Grid
  ctx.strokeStyle = '#202653'; ctx.lineWidth = 1; ctx.beginPath();
  const gridY = 4;
  for (let i=0; i<=gridY; i++) { const y = padT + (h-padT-padB)*i/gridY; ctx.moveTo(padL, y); ctx.lineTo(w-padR, y); }
  ctx.stroke();

  // Y labels
  ctx.fillStyle = '#9aa2c7'; ctx.font = '11px system-ui, sans-serif';
  for (let i=0; i<=gridY; i++) {
    const y = padT + (h-padT-padB)*i/gridY;
    const val = maxV - (maxV - minV)*i/gridY;
    ctx.fillText(fmt.format(val), 6, y+4);
  }

  if (values.length >= 1) {
    const xStep = (w - padL - padR) / Math.max(1, years);
    // Shadow
    ctx.strokeStyle = 'rgba(124,156,255,0.35)'; ctx.lineWidth = 5; ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath();
    values.forEach((v, i) => {
      const x = padL + xStep*(i===0?0:i-1);
      const y = padT + (1 - (v - minV)/(maxV - minV || 1)) * (h-padT-padB);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // Main
    ctx.strokeStyle = '#7c9cff'; ctx.lineWidth = 2; ctx.beginPath();
    values.forEach((v, i) => {
      const x = padL + xStep*(i===0?0:i-1);
      const y = padT + (1 - (v - minV)/(maxV - minV || 1)) * (h-padT-padB);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // Dots
    ctx.fillStyle = '#6ce0c3';
    values.forEach((v,i)=>{
      const x = padL + xStep*(i===0?0:i-1);
      const y = padT + (1 - (v - minV)/(maxV - minV || 1)) * (h-padT-padB);
      ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill();
    });
    // X labels
    ctx.fillStyle = '#9aa2c7';
    for (let i=0; i<=10; i++) {
      const x = padL + (w - padL - padR) * (i/10);
      const y = h - 8;
      ctx.fillText('Y'+i, x-8, y);
    }
  }
}

/* ---------- Events ---------- */
function bind() {
  // Allocation labels
  ['allocCash','allocFixed','allocEquity'].forEach(id=>{
    document.getElementById(id).addEventListener('input', updateAllocLabels);
  });
  dom.normalizeBtn.addEventListener('click', normalizeAlloc);
  dom.rebalanceBtn.addEventListener('click', ()=> setAlloc(state.lastAlloc));

  // Presets
  document.querySelectorAll('.pill[data-preset]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const p = btn.getAttribute('data-preset');
      const presets = {
        cautious:  {cash:70,fixed:25,equity:5},
        balanced:  {cash:40,fixed:50,equity:10},
        growth:    {cash:10,fixed:60,equity:30},
        allEquity: {cash:0, fixed:20, equity:80},
        allFixed:  {cash:0, fixed:90, equity:10},
        allCash:   {cash:100,fixed:0, equity:0},
      };
      setAlloc(presets[p]);
    });
  });

  // Assumptions
  dom.applyAssumpBtn.addEventListener('click', readAssumptions);

  // Actions
  dom.commitBtn.addEventListener('click', ()=> {
    if (state.history.length >= 10) return;
    drawYear();
  });
  dom.undoBtn.addEventListener('click', undoYear);
  dom.resetBtn.addEventListener('click', init);

  // Start & seed changes (only effective before first year)
  dom.startBalance.addEventListener('change', ()=>{
    if (state.history.length === 0) {
      state.startBalance = state.value = Math.max(0, Math.round(Number(dom.startBalance.value)||0));
      dom.kpiValue.textContent = fmt.format(state.value);
      drawChart();
    }
  });
  dom.seed.addEventListener('change', ()=>{
    if (state.history.length === 0) init();
  });

  updateAllocLabels();
}
bind();
init();
</script>
</body>
</html>
